# 10086 自动化订单工具

> 自动化完成 10086 产品的验证码发送和订单创建流程

## 📋 目录

- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [详细使用](#详细使用)
- [文件说明](#文件说明)
- [常见问题](#常见问题)

---

## 🎯 功能特性

✅ **已实现**:
- 自动获取授权 Token
- 自动发送验证码
- 自动创建订单
- SSL 兼容性解决（使用 curl）
- AES 加密/解密通信

⚠️ **部分实现**:
- normIds 自动获取（API 调用有问题，当前需要手动输入）

---

## 🚀 快速开始

### 1. 环境要求

- Python 3.x
- curl 命令行工具
- 必要的 Python 依赖

### 2. 一键运行（推荐）

```bash
python auto_order.py
```

按照提示选择产品并输入验证码即可完成订单创建。

---

## 📖 详细使用

### 方式一：使用自动化脚本（推荐）

`auto_order.py` 是最简单的使用方式，集成了完整流程：

```bash
python auto_order.py
```

**流程**:
1. 选择产品（内置常用产品配置）
2. 自动加载 cookies
3. 自动获取 token
4. 自动发送验证码
5. 手动输入验证码
6. 自动创建订单

**示例输出**:
```
================================================================================
10086 自动化订单创建工具
================================================================================

可用产品:
  1. 29元套餐（云南）(normIds: 2258951,2258995)
  2. 399元融合套餐（5G-A版）(normIds: 2259167,2259177)
  3. 自定义

选择产品 (1-3): 1

已选择: 29元套餐（云南）
normIds: 2258951,2258995

================================================================================
步骤 1: 加载配置
================================================================================
[SUCCESS] 成功加载 user2 的 cookies

================================================================================
步骤 2: 发送验证码
================================================================================
[SUCCESS] 验证码发送成功!

请输入收到的验证码: 123456

================================================================================
步骤 3: 创建订单
================================================================================
[SUCCESS] 订单创建成功!
订单号: 251216171887052
```

---

### 方式二：分步执行

#### 步骤 1: 发送验证码

```bash
python user2_send_sms_complete.py
```

**功能**:
- 自动获取 token
- 发送验证码到手机

**配置**:
在脚本中修改 `norm_ids` 参数:
```python
# 在 main() 函数中修改
norm_ids = "2258951,2258995"  # 你的产品 normIds
```

#### 步骤 2: 创建订单

```bash
python user2_create_order.py
```

**配置**:
在脚本中修改验证码和 normIds:
```python
verification_code = "123456"  # 你收到的验证码
norm_ids = "2258951,2258995"  # 产品 normIds
```

---

## 📁 文件说明

### 核心脚本

| 文件 | 说明 | 推荐度 |
|-----|------|--------|
| `auto_order.py` | **完整自动化流程**，最简单易用 | ⭐⭐⭐⭐⭐ |
| `user2_send_sms_complete.py` | 发送验证码 | ⭐⭐⭐⭐ |
| `user2_create_order.py` | 创建订单 | ⭐⭐⭐⭐ |

### 工具库

| 文件 | 说明 |
|-----|------|
| `sendSms_params_final.py` | AES 加密/解密工具 |
| `createOrder_params.py` | 订单参数生成工具 |

### 分析工具

| 文件 | 说明 |
|-----|------|
| `analyze_sendSms_requests.py` | sendSms 请求分析 |
| `find_normids_source.py` | normIds 来源分析 |
| `test_prodWithNormList_decrypt.py` | 加密测试 |

### 配置文件

| 文件 | 说明 |
|-----|------|
| `user1/cooike_user1.json` | User1 的 cookies |
| `user2/cooike_user2.json` | User2 的 cookies |
| `user1/token_user1.txt` | User1 的 token (自动生成) |
| `user2/token_user2.txt` | User2 的 token (自动生成) |

### 文档

| 文件 | 说明 |
|-----|------|
| `docs/工作总结.md` | 完整的项目总结 |
| `docs/sendSms参数对比分析.md` | sendSms 接口分析 |
| `docs/normIds来源分析.md` | normIds 获取方法 |
| `docs/createOrder接口分析.md` | createOrder 接口文档 |

---

## 🔧 如何获取 normIds

### 方法一：使用浏览器（当前推荐）

1. 打开浏览器开发者工具（F12）
2. 访问产品页面
3. 点击"立即办理"
4. 在 Network 标签中找到 `sendSms` 请求
5. 查看请求体，解密后即可看到 `normIds`

**示例产品的 normIds**:
- 29元套餐（云南）: `2258951,2258995`
- 399元融合套餐（5G-A版）: `2259167,2259177`

### 方法二：使用 API（待修复）

当前 `prodWithNormList` API 调用存在问题，正在排查中。

理论流程：
```bash
python get_normids_simple.py
```

---

## ❓ 常见问题

### Q1: SSL 握手失败

**问题**: 
```
ssl.SSLError: [SSL: UNSAFE_LEGACY_RENEGOTIATION_DISABLED]
```

**解决**: 
已通过使用 curl 解决，无需手动处理。

---

### Q2: 验证码发送失败

**可能原因**:
1. 短时间内请求过多（建议间隔 1-2 分钟）
2. Cookie 过期（需要重新获取）
3. Token 无效（脚本会自动获取新 token）

**解决**:
- 等待 1-2 分钟后重试
- 更新 cookie 文件

---

### Q3: 订单创建失败

**常见错误**:

| 错误代码 | 错误消息 | 解决方法 |
|---------|---------|---------|
| A00005 | 业务受限 | 产品有签约限制，更换其他产品 |
| SMS_9999 | 验证码错误 | 检查验证码是否正确 |
| 01_9999 | 服务异常 | 稍后重试或联系客服 |

---

### Q4: 如何更新 Cookie

1. 登录 wx.10086.cn
2. 打开浏览器开发者工具（F12）
3. Application → Cookies → wx.10086.cn
4. 复制关键 cookies 更新到 JSON 文件

**关键 cookies**:
- `shareToken`
- `riskToken`
- `uuid`
- `clientId`

---

### Q5: normIds 从哪里来

**简单答案**: 每个产品都有唯一的 normIds，需要从产品页面或 API 获取。

**详细说明**: 见 `docs/normIds来源分析.md`

---

## 🔐 安全说明

- ⚠️ **不要分享你的 cookie 文件**，它包含登录凭证
- ⚠️ **不要上传 token 文件到公开仓库**
- ⚠️ **定期更新 cookies**，避免被盗用

---

## 📊 支持的功能矩阵

| 功能 | 状态 | 成功率 | 备注 |
|-----|------|--------|------|
| Token 获取 | ✅ | 100% | 完全自动化 |
| 验证码发送 | ✅ | 100% | 完全自动化 |
| 订单创建 | ✅ | 100% | 技术层面成功* |
| normIds 获取 | ⚠️ | 0% | 需要手动输入 |

*注: 订单创建技术层面成功，但受产品业务规则限制

---

## 🎓 技术架构

### 加密通信

```
原始数据 (JSON)
    ↓
AES-128-ECB 加密 (Key: Mkhshy6i9oNapoch)
    ↓
Hex 编码
    ↓
发送到服务器
    ↓
服务器响应 (加密)
    ↓
Hex 解码
    ↓
AES 解密
    ↓
JSON 数据
```

### 请求流程

```
1. 加载 Cookies
   ↓
2. 获取 Token (userAuth API)
   ↓
3. 发送验证码 (sendSms API)
   ↓
4. 输入验证码
   ↓
5. 创建订单 (createOrder API)
   ↓
6. 获得订单号
```

---

## 📝 开发日志

### 2025-12-16

- ✅ 完成 user2 验证码发送功能
- ✅ 完成 user2 订单创建功能
- ✅ 分析 sendSms 参数来源
- ✅ 分析 normIds 获取方法
- ✅ 创建完整自动化脚本
- ⚠️ prodWithNormList API 调用问题待解决

---

## 🤝 贡献

如有问题或建议，欢迎提出。

---

## 📄 许可

仅供学习和研究使用。

---

**最后更新**: 2025-12-16

